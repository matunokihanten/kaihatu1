<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>万華鏡アニメーション（表示版）</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: #000;
    }
    /* canvas を非表示にしていた設定を削除（display: block; で表示） */
    canvas {
      display: block;
    }
  </style>
</head>
<body>
  <canvas id="kaleido"></canvas>
  <script>
    const canvas = document.getElementById("kaleido");
    canvas.width  = window.innerWidth;
    canvas.height = window.innerHeight;
    const ctx = canvas.getContext("2d");
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    
    // 万華鏡のセグメント数と1セグメントあたりの角度
    const segments = 12;
    const stepAngle = (2 * Math.PI) / segments;
    
    let globalAngle = 0;
    
    // オフスクリーンキャンバスによるパターン作成
    const patternCanvas = document.createElement("canvas");
    patternCanvas.width = 400;
    patternCanvas.height = 400;
    const pCtx = patternCanvas.getContext("2d");
    
    function createPattern() {
      pCtx.fillStyle = "#000";
      pCtx.fillRect(0, 0, patternCanvas.width, patternCanvas.height);
    
      for (let i = 0; i < 100; i++){
        pCtx.beginPath();
        const hue = Math.floor(Math.random() * 360);
        pCtx.fillStyle = `hsl(${hue}, 80%, 60%)`;
        const x = Math.random() * patternCanvas.width;
        const y = Math.random() * patternCanvas.height;
        const radius = Math.random() * 20;
        pCtx.arc(x, y, radius, 0, Math.PI * 2);
        pCtx.fill();
      }
    }
    createPattern();
    
    function animate() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    
      ctx.save();
      ctx.translate(centerX, centerY);
      ctx.rotate(globalAngle);
    
      for (let i = 0; i < segments; i++) {
        ctx.save();
        ctx.rotate(i * stepAngle);
    
        if (i % 2 === 0) {
          ctx.scale(1, -1);
        }
    
        ctx.beginPath();
        const radius = Math.sqrt(centerX * centerX + centerY * centerY);
        ctx.arc(0, 0, radius, -stepAngle / 2, stepAngle / 2);
        ctx.closePath();
        ctx.clip();
    
        ctx.drawImage(
          patternCanvas,
          -patternCanvas.width / 2,
          -patternCanvas.height / 2
        );
        ctx.restore();
      }
      ctx.restore();
    
      globalAngle += 0.005;
      requestAnimationFrame(animate);
    }
    animate();
    
    window.addEventListener("resize", () => {
      canvas.width  = window.innerWidth;
      canvas.height = window.innerHeight;
    });
  </script>
</body>
</html>
