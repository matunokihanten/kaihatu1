const settingsScreen = document.getElementById('settings-screen');
const gameScreen = document.getElementById('game-screen');
const startButton = document.getElementById('start-button');
const digitsInput = document.getElementById('digits');
const delayInput = document.getElementById('delay');
const themeSelect = document.getElementById('theme');
const numberDisplay = document.getElementById('number-display');
const answerInput = document.getElementById('answer-input');
const keypad = document.getElementById('keypad');
const clearButton = document.getElementById('clear-button');
const enterButton = document.getElementById('enter-button');
const historyDiv = document.getElementById('history');
const messageDiv = document.getElementById('message');
const scoreDiv = document.getElementById('score');

let digits, delay, theme, number, answer, score, history;

startButton.addEventListener('click', () => {
    digits = parseInt(digitsInput.value);
    delay = parseInt(delayInput.value);
    theme = themeSelect.value;
    document.body.className = theme;
    settingsScreen.style.display = 'none';
    gameScreen.style.display = 'block';
    startGame();
});

function startGame() {
    score = 0;
    history = [];
    scoreDiv.textContent = `スコア: ${score}`;
    nextRound();
}

function nextRound() {
    number = generateNumber(digits);
    numberDisplay.textContent = number;
    numberDisplay.style.opacity = 0;
    setTimeout(() => {
        numberDisplay.style.transition = 'opacity 1s';
        numberDisplay.style.opacity = 1;
        setTimeout(() => {
            numberDisplay.style.opacity = 0;
            setTimeout(() => {
                numberDisplay.textContent = '';
                answerInput.value = '';
                setupKeypad();
            }, 1000);
        }, delay * 1000);
    }, 500);
}

function generateNumber(digits) {
    const min = Math.pow(10, digits - 1);
    const max = Math.pow(10, digits) - 1;
    return Math.floor(Math.random() * (max - min + 1)) + min;
}

function setupKeypad() {
    // キーパッドのイベントリスナーを一度削除
    keypad.removeEventListener('click', handleKeypadClick);
    // 新しいイベントリスナーを追加
    keypad.addEventListener('click', handleKeypadClick);
}

function handleKeypadClick(event) {
    if (event.target.classList.contains('number-button')) {
        answerInput.value += event.target.textContent;
    } else if (event.target.id === 'clear-button') {
        answerInput.value = '';
    } else if (event.target.id === 'enter-button') {
        answer = parseInt(answerInput.value);
        checkAnswer();
    }
}

function checkAnswer() {
    if (history.length === 0 || answer === history[history.length - 1]) {
        score++;
        scoreDiv.textContent = `スコア: ${score}`;
        messageDiv.textContent = '正解！';
        history.push(number);
        historyDiv.textContent = `数字履歴: ${history.join(', ')}`;
        setTimeout(() => {
            messageDiv.textContent = '';
            nextRound();
        }, 1000);
    } else {
        messageDiv.textContent = `不正解！正しい答えは ${history[history.length - 1]} でした。`;
        setTimeout(() => {
            messageDiv.textContent = '';
            gameScreen.style.display = 'none';
            settingsScreen.style.display = 'block';
        }, 2000);
    }
}
