<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Python Game Preview (Pyodide)</title>
  <!-- Pyodide の読み込み -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    textarea {
      width: 100%;
      height: 200px;
      font-family: monospace;
      padding: 5px;
      box-sizing: border-box;
    }
    /* コンソール出力用エリア */
    #console {
      background: #f0f0f0;
      padding: 10px;
      margin-top: 10px;
      height: 150px;
      overflow-y: auto;
      border: 1px solid #ccc;
      white-space: pre-wrap;
      font-family: monospace;
    }
    /* ゲーム表示用キャンバス: 幅と高さは適切に指定 */
    #gameCanvas {
      background: #ffffff;
      border: 1px solid #ccc;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>Python Game Preview (Pyodide)</h1>
  <p>
    下のテキストエリアに Python コードを入力してください。  
    入力したコードは Pyodide により実行され、  
    コンソール出力は「Console Output」に、  
    キャンバス（Game Area）上にゲーム（アニメーション等）が表示されます。
  </p>
  
  <!-- Pythonコード入力エリア -->
  <textarea id="pythonCode" placeholder="ここにPythonコードを入力してください"></textarea>
  
  <h2>Console Output:</h2>
  <div id="console"></div>
  
  <h2>Game Area:</h2>
  <!-- ゲーム表示用キャンバス。サイズは任意に調整してください。 -->
  <canvas id="gameCanvas" width="600" height="400"></canvas>

  <script>
    let pyodide = null;
    let configData = {};

    // JSON 設定ファイルを読み込む
    async function loadConfig() {
      try {
        const response = await fetch('python_exec_data.json');
        configData = await response.json();
        console.log("Config loaded:", configData);
      } catch (error) {
        console.error("Config loading error:", error);
        // 読み込みに失敗した場合は最低限の設定を用意
        configData = {
          settings: { autoRunDelay: 500 },
          packages: [],
          defaultCode: "print('Hello World')"
        };
      }
    }

    // Pyodide の初期化と、必要なパッケージのロード
    async function initPyodideAndPackages() {
      pyodide = await loadPyodide();
      console.log("Pyodide loaded.");
      if (configData.packages && configData.packages.length > 0) {
        console.log("Loading packages:", configData.packages);
        await pyodide.loadPackage(configData.packages);
      }
    }

    // Pythonコードの実行（stdout／stderr をキャプチャ）
    async function runPython() {
      const code = document.getElementById("pythonCode").value;
      const consoleOutput = document.getElementById("console");
      // コンソール出力エリアを初期化
      consoleOutput.textContent = "";

      // ラッパーコードによりユーザーコードの print 等の出力をキャプチャ
      const wrappedCode = `
import sys
from io import StringIO
def run_code():
    stdout_buffer = StringIO()
    sys.stdout = stdout_buffer
    try:
        exec(
\"\"\"${code
  .replace(/\\/g, "\\\\")
  .replace(/"""/g, '\\\"\\\"\\\"')
  .replace(/\$/g, "\\$")}\"\"\"
        )
    except Exception:
        import traceback
        stdout_buffer.write(traceback.format_exc())
    output = stdout_buffer.getvalue()
    sys.stdout = sys.__stdout__
    return output

result = run_code()
print(result)
      `;

      try {
        let output = await pyodide.runPythonAsync(wrappedCode);
        // キャプチャした出力を Console 出力エリアに表示
        consoleOutput.textContent += output;
      }
      catch (error) {
        console.error("Execution error:", error);
        consoleOutput.innerHTML += "<span style='color:red;'>" + error + "</span>";
      }
    }

    // 初期化 & イベント設定
    async function initialize() {
      await loadConfig();
      await initPyodideAndPackages();

      // JSON の defaultCode がある場合、エディタにセット
      if (configData.defaultCode) {
        document.getElementById("pythonCode").value = configData.defaultCode;
      }

      // 初回実行
      runPython();

      // ユーザー入力時、一定時間（autoRunDelay）後に自動実行（デバウンス）
      let timeout = null;
      document.getElementById("pythonCode").addEventListener("input", () => {
        clearTimeout(timeout);
        let delay = (configData.settings && configData.settings.autoRunDelay) || 500;
        timeout = setTimeout(runPython, delay);
      });
    }

    // ページ読み込み時に初期化開始
    initialize();
  </script>
</body>
</html>
