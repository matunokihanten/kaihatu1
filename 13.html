<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ËÄÅÁúºÂØæÁ≠ñ„Éà„É¨„Éº„Éã„É≥„Ç∞ Ultimate v2</title>
    <style>
        :root {
            --bg-color: #000000;
            --accent: #00d2ff;
            --secondary: #3a7bd5;
            --text-color: #eee;
            --panel-bg: rgba(20, 20, 20, 0.85);
        }
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            touch-action: none; /* Prevent scroll on mobile */
        }

        /* --- UI Components --- */
        
        .ui-layer {
            position: absolute;
            z-index: 100;
            width: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: opacity 0.3s;
        }
        .ui-top { top: 10px; }
        .ui-bottom { bottom: 20px; }

        .control-box {
            background: var(--panel-bg);
            backdrop-filter: blur(8px);
            padding: 10px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
            pointer-events: auto;
            text-align: center;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        /* Toggle Button */
        #ui-toggle-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 200;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(50, 50, 50, 0.5);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: auto;
            backdrop-filter: blur(4px);
        }
        #ui-toggle-btn:hover { background: var(--secondary); }

        /* Buttons Grid */
        .mode-group { display: flex; gap: 4px; justify-content: center; margin-bottom: 8px; }
        .target-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 4px; 
            margin-bottom: 4px; 
        }

        button {
            padding: 6px 4px;
            font-size: 0.75rem;
            cursor: pointer;
            border: 1px solid #444;
            background: #222;
            color: #aaa;
            border-radius: 4px;
            transition: 0.2s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        button:hover { background: #333; }
        button.active { 
            background: var(--secondary); 
            color: white; 
            border-color: var(--accent); 
            box-shadow: 0 0 8px rgba(58, 123, 213, 0.4); 
        }

        /* Sliders */
        .row { display: flex; align-items: center; justify-content: space-between; width: 100%; margin: 4px 0; font-size: 0.8rem; }
        input[type="range"] { flex: 1; margin-left: 10px; cursor: pointer; accent-color: var(--accent); }

        /* --- Display Area & Canvas --- */
        
        #display-area {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        /* Responsive Canvas Wrapper */
        .canvas-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.1s;
        }

        canvas {
            border-radius: 50%;
            /* Default desktop size */
            width: 300px;
            height: 300px;
            /* Responsive: Max 42% of viewport width to fit 2 side-by-side on mobile */
            max-width: 42vw;
            max-height: 42vw;
        }

        /* --- Specific Modes --- */
        #container-stereo {
            display: flex;
            /* Dynamic gap handled by JS, but prevent wrapping */
            flex-wrap: nowrap;
            align-items: center;
            justify-content: center;
            position: relative;
            width: 100%;
        }

        .guide-dots {
            position: absolute;
            top: -25px;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 0; /* Controlled by JS to match canvas centers */
            pointer-events: none;
        }
        .dot { 
            width: 10px; height: 10px; 
            background: #ff3333; 
            border-radius: 50%; 
            box-shadow: 0 0 5px #ff0000;
        }

        /* Utilities */
        .hidden { display: none !important; opacity: 0; pointer-events: none; }
        
    </style>
</head>
<body>

    <button id="ui-toggle-btn" onclick="toggleUI()">üëÅÔ∏è</button>

    <div id="ui-top" class="ui-layer ui-top">
        <div class="control-box">
            <div class="mode-group">
                <button id="mode-stereo" class="active" onclick="setMode('stereo')">3ÁÇπË¶ñ</button>
                <button id="mode-zoom" onclick="setMode('zoom')">ÈÅ†Ëøë</button>
                <button id="mode-move" onclick="setMode('move')">ÁúºÁêÉÈÅãÂãï</button>
            </div>
            
            <div class="target-grid">
                <button id="type-gabor" class="active" onclick="setTarget('gabor')">„Ç¨„Éú„Éº„É´</button>
                <button id="type-stream" onclick="setTarget('stream')">ÊµÅÁ∑öÊ∏¶Â∑ª„Åç</button>
                <button id="type-contrast" onclick="setTarget('contrast')">È´ò„Ç≥„É≥„Éà„É©„Çπ„Éà</button>
                
                <button id="type-geo" onclick="setTarget('geo')">Âπæ‰ΩïÂ≠¶Ê∏¶Â∑ª„Åç</button>
                <button id="type-circle" onclick="setTarget('circle')">ÊôÆÈÄö„ÅÆÂÜÜ</button>
                <button id="type-landolt" onclick="setTarget('landolt')">„É©„É≥„Éâ„É´„Éà</button>

                <button id="type-radial" onclick="setTarget('radial')">ÊîæÂ∞ÑÂÖâ</button>
                <button id="type-bullseye" onclick="setTarget('bullseye')">„Çø„Éº„Ç≤„ÉÉ„Éà</button>
                <button id="type-mandala" onclick="setTarget('mandala')">‰∏áËèØÈè°</button>
            </div>
        </div>
    </div>

    <div id="display-area">
        <div id="container-stereo">
            <div class="guide-dots hidden" id="stereo-guide">
                <div class="dot"></div>
                <div id="dot-spacer" style="width: 60px;"></div> 
                <div class="dot"></div>
            </div>
            <div class="canvas-wrapper"><canvas id="cvs1" width="300" height="300"></canvas></div>
            <div class="canvas-wrapper"><canvas id="cvs2" width="300" height="300"></canvas></div>
        </div>

        <div id="container-single" class="hidden" style="position: absolute;">
            <div class="canvas-wrapper"><canvas id="cvs-single" width="300" height="300"></canvas></div>
        </div>
    </div>

    <div id="ui-bottom" class="ui-layer ui-bottom">
        <div class="control-box">
            <div class="row">
                <span>ÂõûËª¢ÈÄüÂ∫¶</span>
                <input type="range" id="speedRange" min="0" max="100" value="20">
            </div>
            
            <div id="ctrl-stereo" class="ctrl-group">
                <div class="row">
                    <span>ÁîªÂÉèÈñìÈöî</span>
                    <input type="range" id="gapRange" min="0" max="150" value="40">
                </div>
                <div class="row" style="justify-content: center;">
                    <button onclick="toggleGuide()" style="width:100%">üî¥ „Ç¨„Ç§„ÉâË°®Á§∫</button>
                </div>
            </div>

            <div id="ctrl-zoom" class="ctrl-group hidden">
                <div class="row">
                    <span>‰º∏Á∏ÆÈÄüÂ∫¶</span>
                    <input type="range" id="zoomSpeedRange" min="1" max="100" value="30">
                </div>
            </div>

            <div id="ctrl-move" class="ctrl-group hidden">
                <div class="row">
                    <span>ÁßªÂãïÈÄüÂ∫¶</span>
                    <input type="range" id="moveSpeedRange" min="1" max="100" value="30">
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Application State ---
        const state = {
            mode: 'stereo', // stereo, zoom, move
            target: 'gabor', 
            rotation: 0,
            rotationSpeed: 0.02,
            gap: 40,
            zoomScale: 1,
            zoomDir: 1,
            zoomSpeed: 0.01,
            moveX: 50, moveY: 50, velX: 0.5, velY: 0.4,
            width: 300, height: 300,
            uiVisible: true
        };

        // --- DOM Elements ---
        const containers = {
            stereo: document.getElementById('container-stereo'),
            single: document.getElementById('container-single')
        };
        const ctrls = {
            stereo: document.getElementById('ctrl-stereo'),
            zoom: document.getElementById('ctrl-zoom'),
            move: document.getElementById('ctrl-move')
        };
        const canvases = [
            document.getElementById('cvs1'),
            document.getElementById('cvs2'),
            document.getElementById('cvs-single')
        ];
        const uiLayers = [
            document.getElementById('ui-top'),
            document.getElementById('ui-bottom')
        ];

        // --- Core Loop ---
        function init() {
            updateGap(state.gap);
            loop();
        }

        function loop() {
            update();
            draw();
            requestAnimationFrame(loop);
        }

        function update() {
            // Rotation
            state.rotation += state.rotationSpeed;

            // Zoom Mode
            if (state.mode === 'zoom') {
                state.zoomScale += state.zoomSpeed * state.zoomDir;
                if (state.zoomScale > 1.5 || state.zoomScale < 0.2) state.zoomDir *= -1;
                const wrapper = containers.single.querySelector('.canvas-wrapper');
                wrapper.style.transform = `scale(${state.zoomScale})`;
            }

            // Move Mode
            if (state.mode === 'move') {
                let px = state.moveX; 
                let py = state.moveY;
                const speedMult = document.getElementById('moveSpeedRange').value / 20;

                px += state.velX * speedMult;
                py += state.velY * speedMult;

                if (px < 5 || px > 95) state.velX *= -1;
                if (py < 5 || py > 95) state.velY *= -1;

                state.moveX = px;
                state.moveY = py;

                containers.single.style.left = `${px}%`;
                containers.single.style.top = `${py}%`;
                containers.single.style.transform = `translate(-50%, -50%)`;
            }
        }

        function draw() {
            canvases.forEach(canvas => {
                if (canvas.offsetParent === null) return; // Optimization

                const ctx = canvas.getContext('2d');
                const w = canvas.width;
                const h = canvas.height;
                const cx = w / 2;
                const cy = h / 2;
                const radius = 140;

                ctx.clearRect(0, 0, w, h);
                ctx.save();
                ctx.translate(cx, cy);
                ctx.rotate(state.rotation);

                // Dispatch Drawing based on Target Type
                switch(state.target) {
                    case 'gabor': drawGabor(ctx, radius); break;
                    case 'stream': drawStream(ctx, radius); break;
                    case 'contrast': drawContrast(ctx, radius); break;
                    case 'geo': drawGeo(ctx, radius); break;
                    case 'circle': drawCircle(ctx, radius); break;
                    case 'landolt': drawLandolt(ctx, radius); break;
                    case 'radial': drawRadial(ctx, radius); break;
                    case 'bullseye': drawBullseye(ctx, radius); break;
                    case 'mandala': drawMandala(ctx, radius); break;
                    default: drawGabor(ctx, radius);
                }

                ctx.restore();
            });
        }

        // --- Drawing Functions (9 Types) ---

        // 1. Gabor (Blurred Stripes)
        function drawGabor(ctx, r) {
            const stripeW = 20;
            ctx.fillStyle = '#fff';
            for(let i = -r; i < r; i+=stripeW*2) {
                ctx.fillRect(i, -r, stripeW, r*2);
            }
            ctx.filter = 'blur(8px)'; 
            // Mask
            ctx.globalCompositeOperation = 'destination-in';
            const g = ctx.createRadialGradient(0, 0, 0, 0, 0, r);
            g.addColorStop(0, 'rgba(255,255,255,1)');
            g.addColorStop(0.5, 'rgba(255,255,255,0.8)');
            g.addColorStop(1, 'rgba(255,255,255,0)');
            ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.fillStyle = g; ctx.fill();
            ctx.globalCompositeOperation = 'source-over';
            ctx.filter = 'none';
        }

        // 2. Stream (Classic Fluid Vortex)
        function drawStream(ctx, r) {
            ctx.beginPath(); ctx.arc(0, 0, r, 0, Math.PI * 2);
            ctx.fillStyle = '#3498db'; ctx.fill();
            ctx.fillStyle = '#003366';
            for (let j = 0; j < 6; j++) {
                ctx.rotate((Math.PI * 2) / 6);
                ctx.beginPath(); ctx.moveTo(0, 0);
                for (let i = 0; i <= r; i += 2) ctx.lineTo(Math.cos(i/40)*i, Math.sin(i/40)*i);
                for (let i = r; i >= 0; i -= 2) ctx.lineTo(Math.cos(i/40-(i/r)*0.8)*i, Math.sin(i/40-(i/r)*0.8)*i);
                ctx.fill();
            }
        }

        // 3. Contrast (High Contrast Shapes)
        function drawContrast(ctx, r) {
            ctx.fillStyle = '#fff';
            ctx.beginPath(); ctx.arc(0, 0, r, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = '#000';
            for(let i=0; i<4; i++) {
                ctx.rotate(Math.PI/2);
                ctx.fillRect(10, -10, r, 20);
            }
        }

        // 4. Geometric (Sharp Triangles - Restored)
        function drawGeo(ctx, r) {
             for (let i = 0; i < 24; i++) {
                ctx.beginPath();
                ctx.rotate((Math.PI * 2) / 24);
                ctx.moveTo(0, 0);
                ctx.arc(0, 0, r, 0, (Math.PI * 2) / 48);
                ctx.fillStyle = i % 2 === 0 ? '#3498db' : '#003366';
                ctx.fill();
            }
        }

        // 5. Circle (Simple Blue - Restored)
        function drawCircle(ctx, r) {
            ctx.beginPath();
            ctx.arc(0, 0, r, 0, Math.PI * 2);
            ctx.fillStyle = '#3498db';
            ctx.fill();
            // Add a small center dot for focus
            ctx.beginPath();
            ctx.arc(0, 0, 5, 0, Math.PI * 2);
            ctx.fillStyle = '#fff';
            ctx.fill();
        }

        // 6. Landolt (C Ring)
        function drawLandolt(ctx, r) {
            ctx.fillStyle = '#fff';
            ctx.beginPath();
            ctx.arc(0, 0, r*0.8, 0, Math.PI*2);
            ctx.arc(0, 0, r*0.5, 0, Math.PI*2, true); // Hole
            ctx.fill();
            // Cutout
            ctx.fillStyle = '#000'; // BG color
            ctx.beginPath();
            ctx.fillRect(r*0.4, -r*0.15, r*0.5, r*0.3);
        }

        // 7. Radial (Starburst)
        function drawRadial(ctx, r) {
            ctx.strokeStyle = '#00d2ff';
            ctx.lineWidth = 4;
            for(let i=0; i<16; i++) {
                ctx.rotate(Math.PI/8);
                ctx.beginPath();
                ctx.moveTo(20, 0);
                ctx.lineTo(r, 0);
                ctx.stroke();
            }
            ctx.fillStyle = '#fff';
            ctx.beginPath(); ctx.arc(0,0,10,0,Math.PI*2); ctx.fill();
        }

        // 8. Bullseye (Concentric)
        function drawBullseye(ctx, r) {
            const colors = ['#fff', '#3a7bd5', '#fff', '#3a7bd5', '#fff', '#3a7bd5'];
            for(let i=0; i<6; i++) {
                ctx.beginPath();
                ctx.arc(0, 0, r - (i*(r/6)), 0, Math.PI*2);
                ctx.fillStyle = colors[i];
                ctx.fill();
            }
        }

        // 9. Mandala (Kaleidoscope)
        function drawMandala(ctx, r) {
            ctx.strokeStyle = 'rgba(0, 210, 255, 0.6)';
            ctx.lineWidth = 2;
            for(let i=0; i<12; i++) {
                ctx.rotate(Math.PI/6);
                ctx.beginPath();
                ctx.ellipse(r/2, 0, r/2, r/4, 0, 0, Math.PI*2);
                ctx.stroke();
            }
            ctx.fillStyle = '#fff';
            ctx.beginPath(); ctx.arc(0,0,5,0,Math.PI*2); ctx.fill();
        }


        // --- UI & Logic Functions ---

        function toggleUI() {
            state.uiVisible = !state.uiVisible;
            uiLayers.forEach(el => el.classList.toggle('hidden', !state.uiVisible));
            document.getElementById('ui-toggle-btn').style.opacity = state.uiVisible ? '1' : '0.3';
        }

        function setMode(mode) {
            state.mode = mode;
            document.querySelectorAll('.mode-group button').forEach(b => b.classList.remove('active'));
            document.getElementById(`mode-${mode}`).classList.add('active');

            containers.stereo.classList.toggle('hidden', mode !== 'stereo');
            containers.single.classList.toggle('hidden', mode === 'stereo');

            Object.keys(ctrls).forEach(k => ctrls[k].classList.add('hidden'));
            ctrls[mode].classList.remove('hidden');

            if(mode === 'zoom') {
                containers.single.style.left = '50%';
                containers.single.style.top = '50%';
                containers.single.style.transform = 'translate(-50%, -50%)';
            }
        }

        function setTarget(type) {
            state.target = type;
            document.querySelectorAll('.target-grid button').forEach(b => b.classList.remove('active'));
            document.getElementById(`type-${type}`).classList.add('active');
        }

        function updateGap(val) {
            state.gap = val;
            containers.stereo.style.gap = `${val}px`;
            // Update guide dots spacer
            document.getElementById('dot-spacer').style.width = `${val}px`;
        }

        function toggleGuide() {
            document.getElementById('stereo-guide').classList.toggle('hidden');
        }

        // Events
        document.getElementById('speedRange').addEventListener('input', e => {
            state.rotationSpeed = e.target.value / 500;
        });
        document.getElementById('gapRange').addEventListener('input', e => {
            updateGap(e.target.value);
        });
        document.getElementById('zoomSpeedRange').addEventListener('input', e => {
            state.zoomSpeed = e.target.value / 1000;
        });
        document.getElementById('moveSpeedRange').addEventListener('input', e => {
            // Read in loop
        });

        // Initialize
        init();

    </script>
</body>
</html>
